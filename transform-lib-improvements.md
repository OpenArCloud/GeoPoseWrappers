# Transform Library Improvements Plan

## Goals
- Ensure math correctness and GeoPose spec alignment (YPR, ENU/ECEF, relative pose).
- Provide clearer, real-world examples that help end users understand transformations.
- Add projected-coordinate transforms (UTM and generic projections) and surface them in the demo.
- Expand tests with independent reference values and edge cases.

## Current Issues To Fix (from review)
- Basic-YPR yaw convention likely mismatched (spec says yaw 0 = North; current math assumes yaw 0 aligns with +X/East).
- ENU<->ECEF orientation composition appears inverted or inconsistent (round-trip likely wrong).
- Relative pose ignores base orientation; translate/relative behave as if base orientation is identity.
- Tests are self-referential (fixtures are generated by the same code under test).
- Quaternion normalization is not enforced after matrix/multiplication or slerp.

## Phase 0: Lock Down Conventions
- Confirm the intended Basic-YPR yaw reference and sign conventions from OGC (north-based heading).
- Define quaternion meaning explicitly (ENU->body vs body->ENU).
- Document the frame conventions in the library README and in code-level comments at the conversion entry points.

## Phase 1: Core Math Corrections
- Update `quaternionToYPR` / `yprToQuaternion` to match the chosen yaw reference.
- Fix ENU<->ECEF orientation transforms so `ecefToGeoPose(geoPoseToECEF(x))` returns orientation correctly.
- Rework `getRelativePose` / `applyRelativePose` to apply base orientation (relative rotation should be in the base pose frame).
- Rework `translateGeoPose` to preserve orientation correctly in the target local frame.
- Add quaternion normalization at all conversion boundaries.
- Consolidate quaternion/matrix utilities into a shared module to avoid drift.

## Phase 2: Testing Overhaul
- Replace self-generated fixtures with independent reference data (from trusted geodesy tools or external libraries).
- Add orientation tests for ENU<->ECEF and YPR<->Quaternion conversions.
- Add property tests for round-trip stability, unit quaternion, and approximate invariants.
- Add edge cases: poles, dateline, large altitude, negative altitude, pitch +/-90, and near-zero translation.
- Add test-data README with sources and exact expected values.

## Phase 3: Real-World Locations + GLB Assets + 3D Tiles
- Add a `test-data/locations.json` with real-world points (name, lat, lon, h, notes).
  - Example set: Eiffel Tower, Statue of Liberty, Tokyo Tower, Sydney Opera House, Golden Gate, Machu Picchu.
- Add scenario records that apply transforms with clear intent:
  - "Translate 100m north", "Rotate 45 deg yaw", "Relative pose to another landmark".
- Pair each scenario with a directional GLB asset and a target pose to visualize orientation.
- Update the demo to load these scenarios and assets from test data:
  - Scenario selector with readable labels.
  - Live delta readouts (ENU, ECEF, YPR) and pass/fail thresholds.
- Add a Google Photorealistic 3D Tiles base layer option:
  - Use a configuration toggle (env var / local config) for API key or Cesium ion asset id.
  - Keep a fallback base layer when keys are missing.
  - Document setup and limitations (network required).

## Phase 4: Projected Coordinate Transforms (UTM + Generic)
- Add types:
  - `UTM` (easting, northing, zone, hemisphere).
  - `Projected` (x, y, z, projection id / proj string).
- Add APIs:
  - `geoPoseToUTM(geoPose): { position: UTM & { h }, orientation }`
  - `utmToGeoPose(utm, orientation): GeoPoseBQ`
  - `geoPoseToProjected(geoPose, projection): { position: { x, y, z }, orientation }`
  - `projectedToGeoPose(projected, projection, orientation): GeoPoseBQ`
- Implementation approach:
  - Implement UTM directly (zone, false easting/northing, hemisphere rules).
  - For generic projections, add an optional adapter to `proj4` (behind a thin interface).
- Orientation rules:
  - Align projected X/Y with East/North; Z is up.
  - Document grid convergence and its effect; optionally add a correction hook later.

## Phase 5: Demo Enhancements For Projections
- Add a coordinate system switcher (WGS84 / ECEF / ENU / UTM / Projected).
- Show read-only values for each representation; allow editing in UTM/Projected and apply to entity.
- Add a "conversion report" panel with numeric errors and unit checks.
- Visualize transforms with a path or ghost entity showing before/after.

## Deliverables
- Corrected core conversion logic and shared math utilities.
- Expanded test suite with independent fixtures and edge cases.
- Real-world test data and scenario-driven demo with GLB assets.
- Optional Google Photorealistic 3D Tiles setup.
- New UTM/projected transform APIs and demo tooling.

## Out Of Scope (for this plan)
- Porting to other language targets (Kotlin/Swift/etc) unless explicitly requested.
